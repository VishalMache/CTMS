// ============================================================
// CPMS – Prisma Schema (PostgreSQL Version for Supabase)
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// ENUMS  (PostgreSQL native enum types)
// ─────────────────────────────────────────────

enum Role {
  STUDENT
  TPO_ADMIN
}

enum Branch {
  CSE
  IT
  ECE
  MECH
  CIVIL
  EE
}

enum CertificateType {
  INTERNSHIP
  TRAINING
  OTHER
}

enum CompanyStatus {
  UPCOMING
  ACTIVE
  COMPLETED
}

enum RoundName {
  PRE_PLACEMENT
  APTITUDE
  TECHNICAL_TEST
  TECHNICAL_INTERVIEW
  HR_INTERVIEW
  FINAL_RESULT
}

enum ResultStatus {
  SELECTED
  REJECTED
  PENDING
  ABSENT
}

enum SessionType {
  TECHNICAL_LECTURE
  MOCK_INTERVIEW
  APTITUDE
  HR_PREP
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum MockTestType {
  APTITUDE
  TECHNICAL
  CODING
}

enum NotificationType {
  EMAIL
  IN_APP
  INFO
  SUCCESS
  WARNING
  ERROR
}

// ─────────────────────────────────────────────
// Model 1: User  (Auth entity)
// ─────────────────────────────────────────────
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student       Student?
  notifications Notification[]
}

// ─────────────────────────────────────────────
// Model 2: Student
// ─────────────────────────────────────────────
model Student {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  firstName        String
  lastName         String
  phone            String?
  gender           String?
  enrollmentNumber String  @unique
  branch           Branch

  tenth_percent   Float
  twelfth_percent Float
  cgpa            Float

  activeBacklogs Boolean @default(false)
  totalBacklogs  Int     @default(0)

  resumeUrl       String?
  profilePhotoUrl String?

  hasInternship     Boolean @default(false)
  internshipDetails String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  certificates        Certificate[]
  driveRegistrations  DriveRegistration[]
  roundResults        RoundResult[]
  trainingAttendances TrainingAttendance[]
  mockTestResults     MockTestResult[]
}

// ─────────────────────────────────────────────
// Model 3: Certificate
// ─────────────────────────────────────────────
model Certificate {
  id        String  @id @default(cuid())
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  title   String
  fileUrl String
  type    CertificateType

  uploadedAt DateTime @default(now())
}

// ─────────────────────────────────────────────
// Model 4: Company
// ─────────────────────────────────────────────
model Company {
  id      String @id @default(cuid())
  name    String
  jobRole String
  ctc     Float

  eligibilityCGPA    Float
  eligibilityPercent Float

  // PostgreSQL native array — replaces the comma-separated String workaround
  allowedBranches Branch[]

  driveDate    DateTime
  description  String?
  noticePdfUrl String?

  status CompanyStatus @default(UPCOMING)

  createdAt DateTime @default(now())

  driveRegistrations DriveRegistration[]
  selectionRounds    SelectionRound[]
}

// ─────────────────────────────────────────────
// Model 5: DriveRegistration
// ─────────────────────────────────────────────
model DriveRegistration {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  registeredAt DateTime @default(now())
  isEligible   Boolean  @default(false)

  @@unique([companyId, studentId])
}

// ─────────────────────────────────────────────
// Model 6: SelectionRound
// ─────────────────────────────────────────────
model SelectionRound {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  roundNumber Int
  roundName   RoundName

  scheduledDate DateTime?

  roundResults RoundResult[]

  @@unique([companyId, roundNumber])
}

// ─────────────────────────────────────────────
// Model 7: RoundResult
// ─────────────────────────────────────────────
model RoundResult {
  id        String         @id @default(cuid())
  roundId   String
  round     SelectionRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  studentId String
  student   Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status  ResultStatus @default(PENDING)
  remarks String?

  updatedAt DateTime @updatedAt

  @@unique([roundId, studentId])
}

// ─────────────────────────────────────────────
// Model 8: TrainingSession
// ─────────────────────────────────────────────
model TrainingSession {
  id          String      @id @default(cuid())
  title       String
  type        SessionType
  conductedBy String
  sessionDate DateTime
  description String?

  attendances TrainingAttendance[]
}

// ─────────────────────────────────────────────
// Model 9: TrainingAttendance
// ─────────────────────────────────────────────
model TrainingAttendance {
  id        String          @id @default(cuid())
  sessionId String
  session   TrainingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentId String
  student   Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  status   AttendanceStatus @default(ABSENT)
  markedAt DateTime         @default(now())

  @@unique([sessionId, studentId])
}

// ─────────────────────────────────────────────
// Model 10: MockTest
// ─────────────────────────────────────────────
model MockTest {
  id         String       @id @default(cuid())
  title      String
  type       MockTestType
  duration   Int
  totalMarks Int

  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())

  questions MockTestQuestion[]
  results   MockTestResult[]
}

// ─────────────────────────────────────────────
// Model 11: MockTestQuestion
// ─────────────────────────────────────────────
model MockTestQuestion {
  id     String   @id @default(cuid())
  testId String
  test   MockTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  questionText  String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String
  marks         Int     @default(1)
  subject       String?
}

// ─────────────────────────────────────────────
// Model 12: MockTestResult
// ─────────────────────────────────────────────
model MockTestResult {
  id        String   @id @default(cuid())
  testId    String
  test      MockTest @relation(fields: [testId], references: [id], onDelete: Cascade)
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  score          Int
  totalMarks     Int
  timeTaken      Int
  correctAnswers Int
  wrongAnswers   Int

  attemptedAt DateTime @default(now())

  @@unique([testId, studentId])
}

// ─────────────────────────────────────────────
// Model 13: Notification
// ─────────────────────────────────────────────
model Notification {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  title   String
  message String
  type    NotificationType @default(INFO)

  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}
